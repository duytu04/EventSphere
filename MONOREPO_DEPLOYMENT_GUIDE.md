# üöÄ EventSphere Monorepo Azure Deployment Guide

## üìã T·ªïng quan Monorepo
- **C·∫•u tr√∫c**: Monorepo v·ªõi frontend v√† backend trong c√πng repository
- **Frontend**: Azure Static Web Apps (t·ª´ `/frontend`)
- **Backend**: Azure App Service (t·ª´ `/backend`)
- **Database**: Azure Database for MySQL Flexible Server
- **CI/CD**: GitHub Actions v·ªõi selective deployment

---

## üèóÔ∏è C·∫•u tr√∫c Monorepo

```
EventSphere/
‚îú‚îÄ‚îÄ frontend/                    # React + Vite frontend
‚îÇ   ‚îú‚îÄ‚îÄ src/                    # Source code
‚îÇ   ‚îú‚îÄ‚îÄ package.json            # Dependencies
‚îÇ   ‚îú‚îÄ‚îÄ vite.config.ts          # Build config
‚îÇ   ‚îî‚îÄ‚îÄ staticwebapp.config.json # SWA config
‚îú‚îÄ‚îÄ backend/                     # Spring Boot backend
‚îÇ   ‚îú‚îÄ‚îÄ src/                    # Source code
‚îÇ   ‚îú‚îÄ‚îÄ pom.xml                 # Maven dependencies
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile              # Multi-stage build
‚îÇ   ‚îî‚îÄ‚îÄ src/main/resources/
‚îÇ       ‚îî‚îÄ‚îÄ application-azure.yml # Azure config
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ azure-deploy.yml    # CI/CD pipeline
‚îú‚îÄ‚îÄ azure-deploy.bicep          # Infrastructure as Code
‚îú‚îÄ‚îÄ deploy-azure.ps1            # Deployment script
‚îî‚îÄ‚îÄ azure-env.example           # Environment template
```

---

## üîß B∆Ø·ªöC 1: Chu·∫©n b·ªã Monorepo

### 1.1 C·∫•u tr√∫c Repository
ƒê·∫£m b·∫£o repository c√≥ c·∫•u tr√∫c monorepo:
```
your-username/EventSphere
‚îú‚îÄ‚îÄ frontend/     # Frontend code
‚îú‚îÄ‚îÄ backend/      # Backend code
‚îî‚îÄ‚îÄ .github/      # CI/CD workflows
```

### 1.2 C·∫•u h√¨nh Environment Variables
```powershell
# Copy template
cp azure-env.example .env.azure

# C·∫≠p nh·∫≠t v·ªõi th√¥ng tin th·ª±c t·∫ø
```

```env
# Azure Configuration
AZURE_RESOURCE_GROUP=eventsphere-rg
AZURE_LOCATION=East US
AZURE_ENVIRONMENT=dev
AZURE_APP_NAME_PREFIX=eventsphere

# Repository Configuration
REPOSITORY_URL=https://github.com/yourusername/EventSphere
BRANCH_NAME=main

# Database Configuration
MYSQL_ADMIN_LOGIN=eventsphereadmin
MYSQL_ADMIN_PASSWORD=MySecurePassword123!

# JWT Configuration
JWT_SECRET=my-super-secret-jwt-key-for-azure-production-2024

# Email Configuration (Optional)
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
```

---

## üöÄ B∆Ø·ªöC 2: Deploy Infrastructure

### 2.1 Deploy to√†n b·ªô (Infrastructure + Apps)
```powershell
.\deploy-azure.ps1 `
    -ResourceGroupName "eventsphere-rg" `
    -Location "East US" `
    -EnvironmentName "dev" `
    -AppNamePrefix "eventsphere" `
    -RepositoryUrl "https://github.com/yourusername/EventSphere" `
    -BranchName "main" `
    -MySqlAdminPassword "MySecurePassword123!" `
    -JwtSecret "my-super-secret-jwt-key-for-azure-production-2024"
```

### 2.2 Deploy t·ª´ng ph·∫ßn ri√™ng bi·ªát

#### Ch·ªâ deploy Infrastructure:
```powershell
.\deploy-azure.ps1 `
    -ResourceGroupName "eventsphere-rg" `
    -RepositoryUrl "https://github.com/yourusername/EventSphere" `
    -MySqlAdminPassword "MySecurePassword123!" `
    -JwtSecret "my-super-secret-jwt-key-for-azure-production-2024" `
    -DeployFrontend:$false `
    -DeployBackend:$false
```

#### Ch·ªâ deploy Backend:
```powershell
.\deploy-azure.ps1 `
    -ResourceGroupName "eventsphere-rg" `
    -RepositoryUrl "https://github.com/yourusername/EventSphere" `
    -MySqlAdminPassword "MySecurePassword123!" `
    -JwtSecret "my-super-secret-jwt-key-for-azure-production-2024" `
    -DeployInfrastructure:$false `
    -DeployFrontend:$false
```

#### Ch·ªâ deploy Frontend:
```powershell
.\deploy-azure.ps1 `
    -ResourceGroupName "eventsphere-rg" `
    -RepositoryUrl "https://github.com/yourusername/EventSphere" `
    -MySqlAdminPassword "MySecurePassword123!" `
    -JwtSecret "my-super-secret-jwt-key-for-azure-production-2024" `
    -DeployInfrastructure:$false `
    -DeployBackend:$false
```

---

## üîÑ B∆Ø·ªöC 3: C·∫•u h√¨nh CI/CD

### 3.1 GitHub Actions Workflow
File `.github/workflows/azure-deploy.yml` ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh v·ªõi:
- **Selective deployment**: Ch·ªâ deploy khi c√≥ thay ƒë·ªïi
- **Path-based triggers**: 
  - `frontend/**` ‚Üí Deploy frontend
  - `backend/**` ‚Üí Deploy backend
- **Parallel jobs**: Frontend v√† backend deploy song song
- **Infrastructure deployment**: Ch·ªâ tr√™n main branch

### 3.2 C·∫•u h√¨nh GitHub Secrets
Trong GitHub repository, th√™m c√°c secrets:

#### Required Secrets:
- `AZURE_CREDENTIALS` - Azure service principal
- `AZURE_RESOURCE_GROUP` - Resource group name
- `MYSQL_ADMIN_PASSWORD` - Database password
- `JWT_SECRET` - JWT secret key

#### Optional Secrets:
- `AZURE_STATIC_WEB_APPS_API_TOKEN` - For SWA deployment
- `AZURE_WEBAPP_PUBLISH_PROFILE` - For App Service deployment
- `ACR_USERNAME` - Container registry username
- `ACR_PASSWORD` - Container registry password

### 3.3 T·∫°o Azure Service Principal
```powershell
# T·∫°o service principal
az ad sp create-for-rbac --name "EventSphere-CI" --role contributor --scopes /subscriptions/{subscription-id}/resourceGroups/eventsphere-rg --sdk-auth

# Copy output JSON v√† paste v√†o GitHub Secrets > AZURE_CREDENTIALS
```

---

## üåê B∆Ø·ªöC 4: Deploy Frontend (Azure Static Web Apps)

### 4.1 T·∫°o Static Web App
```powershell
# T·∫°o Static Web App cho monorepo
az staticwebapp create `
    --name eventsphere-frontend `
    --resource-group eventsphere-rg `
    --source https://github.com/yourusername/EventSphere `
    --location "East US 2" `
    --branch main `
    --app-location "/frontend" `
    --output-location "dist" `
    --build-command "cd frontend && npm ci && npm run build"
```

### 4.2 C·∫•u h√¨nh Environment Variables
```powershell
# Set environment variables cho frontend
az staticwebapp appsettings set `
    --name eventsphere-frontend `
    --resource-group eventsphere-rg `
    --setting-names VITE_API_BASE_URL=https://eventsphere-backend.azurewebsites.net
```

### 4.3 Deploy th·ªß c√¥ng
```powershell
# Install Azure Static Web Apps CLI
npm install -g @azure/static-web-apps-cli

# Deploy t·ª´ th∆∞ m·ª•c frontend
cd frontend
swa deploy --app-location . --output-location dist
```

---

## üñ•Ô∏è B∆Ø·ªöC 5: Deploy Backend (Azure App Service)

### 5.1 T·∫°o App Service Plan
```powershell
# T·∫°o App Service Plan
az appservice plan create `
    --name eventsphere-plan `
    --resource-group eventsphere-rg `
    --location "East US" `
    --sku B1 `
    --is-linux
```

### 5.2 T·∫°o Web App
```powershell
# T·∫°o Web App
az webapp create `
    --resource-group eventsphere-rg `
    --plan eventsphere-plan `
    --name eventsphere-backend `
    --runtime "JAVA|11-java11"
```

### 5.3 Deploy v·ªõi Docker
```powershell
# T·∫°o Azure Container Registry
az acr create --resource-group eventsphere-rg --name eventsphereacr --sku Basic

# Login to ACR
az acr login --name eventsphereacr

# Build v√† push Docker image
docker build -t eventsphereacr.azurecr.io/eventsphere-backend:latest ./backend
docker push eventsphereacr.azurecr.io/eventsphere-backend:latest

# C·∫•u h√¨nh Web App s·ª≠ d·ª•ng Docker image
az webapp config container set `
    --name eventsphere-backend `
    --resource-group eventsphere-rg `
    --docker-custom-image-name eventsphereacr.azurecr.io/eventsphere-backend:latest
```

---

## üóÑÔ∏è B∆Ø·ªöC 6: C·∫•u h√¨nh Database

### 6.1 T·∫°o MySQL Flexible Server
```powershell
# T·∫°o MySQL server
az mysql flexible-server create `
    --resource-group eventsphere-rg `
    --name eventsphere-mysql `
    --location "East US" `
    --admin-user eventsphereadmin `
    --admin-password "MySecurePassword123!" `
    --sku-name Standard_B1ms `
    --tier Burstable `
    --storage-size 20
```

### 6.2 T·∫°o Database
```powershell
# T·∫°o database
az mysql flexible-server db create `
    --resource-group eventsphere-rg `
    --server-name eventsphere-mysql `
    --database-name eventsphere
```

### 6.3 C·∫•u h√¨nh Firewall
```powershell
# Cho ph√©p Azure services
az mysql flexible-server firewall-rule create `
    --resource-group eventsphere-rg `
    --name eventsphere-mysql `
    --rule-name AllowAzureServices `
    --start-ip-address 0.0.0.0 `
    --end-ip-address 0.0.0.0
```

---

## ‚úÖ B∆Ø·ªöC 7: Ki·ªÉm tra Deployment

### 7.1 Ki·ªÉm tra Backend
```powershell
# L·∫•y URL backend
$backendUrl = az webapp show --resource-group eventsphere-rg --name eventsphere-backend --query "defaultHostName" --output tsv

# Test health check
curl "https://$backendUrl/actuator/health"

# Test API docs
curl "https://$backendUrl/swagger-ui.html"
```

### 7.2 Ki·ªÉm tra Frontend
```powershell
# L·∫•y URL frontend
$frontendUrl = az staticwebapp show --resource-group eventsphere-rg --name eventsphere-frontend --query "defaultHostName" --output tsv

# Test frontend
curl "https://$frontendUrl"
```

### 7.3 Ki·ªÉm tra Database
```powershell
# Test database connection
az mysql flexible-server connect --name eventsphere-mysql --admin-user eventsphereadmin --admin-password "MySecurePassword123!"
```

---

## üîÑ B∆Ø·ªöC 8: Selective Deployment

### 8.1 Deploy ch·ªâ Frontend
```bash
# Ch·ªâ thay ƒë·ªïi frontend code
git add frontend/
git commit -m "Update frontend"
git push origin main

# GitHub Actions s·∫Ω t·ª± ƒë·ªông detect v√† ch·ªâ deploy frontend
```

### 8.2 Deploy ch·ªâ Backend
```bash
# Ch·ªâ thay ƒë·ªïi backend code
git add backend/
git commit -m "Update backend"
git push origin main

# GitHub Actions s·∫Ω t·ª± ƒë·ªông detect v√† ch·ªâ deploy backend
```

### 8.3 Deploy c·∫£ hai
```bash
# Thay ƒë·ªïi c·∫£ frontend v√† backend
git add frontend/ backend/
git commit -m "Update both frontend and backend"
git push origin main

# GitHub Actions s·∫Ω deploy c·∫£ hai song song
```

---

## üîß B∆Ø·ªöC 9: Troubleshooting

### 9.1 L·ªói th∆∞·ªùng g·∫∑p

#### ‚ùå Frontend kh√¥ng deploy
- Ki·ªÉm tra GitHub Actions logs
- Ki·ªÉm tra `AZURE_STATIC_WEB_APPS_API_TOKEN`
- Ki·ªÉm tra build command trong workflow

#### ‚ùå Backend kh√¥ng deploy
- Ki·ªÉm tra Docker build logs
- Ki·ªÉm tra ACR credentials
- Ki·ªÉm tra App Service configuration

#### ‚ùå Database connection failed
- Ki·ªÉm tra firewall rules
- Ki·ªÉm tra credentials
- Ki·ªÉm tra network connectivity

### 9.2 Debug Commands
```powershell
# Xem logs App Service
az webapp log tail --name eventsphere-backend --resource-group eventsphere-rg

# Xem logs Static Web App
az staticwebapp logs --name eventsphere-frontend --resource-group eventsphere-rg

# Ki·ªÉm tra App Service settings
az webapp config appsettings list --name eventsphere-backend --resource-group eventsphere-rg
```

---

## üìä B∆Ø·ªöC 10: Monitoring v√† Maintenance

### 10.1 Application Insights
```powershell
# T·∫°o Application Insights
az monitor app-insights component create `
    --app eventsphere-insights `
    --location "East US" `
    --resource-group eventsphere-rg

# C·∫•u h√¨nh cho Web App
az webapp config appsettings set `
    --name eventsphere-backend `
    --resource-group eventsphere-rg `
    --settings APPINSIGHTS_INSTRUMENTATIONKEY="your-key"
```

### 10.2 Backup Strategy
- **Database**: Azure t·ª± ƒë·ªông backup
- **Code**: GitHub repository
- **Configuration**: Azure Key Vault

### 10.3 Scaling
- **Frontend**: Auto-scaling v·ªõi CDN
- **Backend**: Manual scaling ho·∫∑c auto-scaling
- **Database**: Vertical scaling

---

## üí∞ Chi ph√≠ Monorepo

### Free Tier (Development)
- **Static Web Apps**: Free (100GB bandwidth)
- **App Service**: Free (F1 tier)
- **MySQL**: Free (Basic tier)
- **ACR**: Free (Basic tier)
- **T·ªïng**: $0/th√°ng

### Production Tier
- **Static Web Apps**: $9/th√°ng (Standard)
- **App Service**: $13/th√°ng (B1 tier)
- **MySQL**: $25/th√°ng (General Purpose)
- **ACR**: $5/th√°ng (Basic)
- **T·ªïng**: ~$52/th√°ng

---

## üéØ L·ª£i √≠ch Monorepo

### 1. **Unified Development**
- C√πng m·ªôt repository
- Shared dependencies
- Consistent tooling

### 2. **Selective Deployment**
- Deploy ch·ªâ ph·∫ßn thay ƒë·ªïi
- Faster CI/CD
- Reduced costs

### 3. **Simplified Management**
- Single source of truth
- Easier versioning
- Unified documentation

### 4. **Better Collaboration**
- Shared code standards
- Easier code review
- Cross-team visibility

---

## ‚úÖ Checklist Monorepo Deploy

- [ ] Repository c√≥ c·∫•u tr√∫c monorepo
- [ ] GitHub Actions workflow ƒë√£ c·∫•u h√¨nh
- [ ] GitHub Secrets ƒë√£ set
- [ ] Azure service principal ƒë√£ t·∫°o
- [ ] Infrastructure ƒë√£ deploy
- [ ] Frontend ƒë√£ deploy l√™n SWA
- [ ] Backend ƒë√£ deploy l√™n App Service
- [ ] Database ƒë√£ c·∫•u h√¨nh
- [ ] Health checks pass
- [ ] Selective deployment ho·∫°t ƒë·ªông
- [ ] Monitoring ƒë√£ setup

---

## üéâ Ho√†n th√†nh!

Sau khi ho√†n th√†nh t·∫•t c·∫£ c√°c b∆∞·ªõc tr√™n, b·∫°n s·∫Ω c√≥:
- ‚úÖ Monorepo v·ªõi selective deployment
- ‚úÖ Frontend ch·∫°y tr√™n Azure Static Web Apps
- ‚úÖ Backend ch·∫°y tr√™n Azure App Service
- ‚úÖ Database ch·∫°y tr√™n Azure MySQL Flexible Server
- ‚úÖ CI/CD pipeline v·ªõi GitHub Actions
- ‚úÖ Selective deployment based on changes
- ‚úÖ Monitoring v√† logging

**Ch√∫c m·ª´ng! EventSphere Monorepo ƒë√£ ƒë∆∞·ª£c deploy th√†nh c√¥ng l√™n Azure! üöÄ**
